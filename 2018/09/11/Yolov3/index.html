<!doctype html>
<html lang="ko"><head><meta charset="utf-8"><meta name="generator" content="Hexo 4.2.0"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta><title>Object Detection with YOLOv3 - okdata</title><meta description="Data Engineering 관련 블로그입니다."><meta property="og:type" content="blog"><meta property="og:title" content="okdata"><meta property="og:url" content="https://ok-data.github.io/"><meta property="og:site_name" content="ok-data.github.io"><meta property="og:description" content="Data Engineering 관련 블로그입니다."><meta property="og:locale" content="ko_KR"><meta property="og:image" content="https://ok-data.github.io/assets/logo.png"><meta property="article:published_time" content="2018-09-10T15:00:00.000Z"><meta property="article:modified_time" content="2020-04-23T06:53:08.812Z"><meta property="article:author" content="okdata"><meta property="article:tag" content="Docker"><meta property="article:tag" content="Ubuntu"><meta property="article:tag" content="Machine Learning"><meta property="article:tag" content="Computer Vision"><meta property="twitter:card" content="summary"><meta property="twitter:image" content="/assets/logo.png"><script type="application/ld+json">{"@context":"https://schema.org","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"https://ok-data.github.io"},"headline":"okdata","image":["https://ok-data.github.io/assets/logo.png"],"datePublished":"2018-09-10T15:00:00.000Z","dateModified":"2020-04-23T06:53:08.812Z","author":{"@type":"Person","name":"okdata"},"description":"Data Engineering 관련 블로그입니다."}</script><link rel="canonical" href="https://ok-data.github.io/2018/09/11/Yolov3/"><link rel="icon" href="/assets/favicon.png"><link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.12.0/css/all.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@9.12.0/styles/atom-one-dark.css"><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Ubuntu:wght@400;600&amp;family=Source+Code+Pro"><link rel="stylesheet" href="/css/default.css"><style>body>.footer,body>.navbar,body>.section{opacity:0}</style><!--!--><!--!--><!--!--><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lightgallery@1.6.8/dist/css/lightgallery.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/justifiedGallery@3.7.0/dist/css/justifiedGallery.min.css"><script src="https://www.googletagmanager.com/gtag/js?id=UA-155090711-1" async></script><script>window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
    
        gtag('config', 'UA-155090711-1');</script><!--!--><script src="https://cdn.jsdelivr.net/npm/pace-js@1.0.2/pace.min.js"></script></head><body class="is-2-column"><nav class="navbar navbar-main"><div class="container"><div class="navbar-brand justify-content-center"><a class="navbar-item navbar-logo" href="/"><img src="/assets/title_logo.png" alt="okdata" height="28"></a></div><div class="navbar-menu"><div class="navbar-start"><a class="navbar-item" href="/">Home</a><a class="navbar-item" href="/archives">Archives</a><a class="navbar-item" href="/categories">Categories</a><a class="navbar-item" href="/tags">Tags</a><a class="navbar-item" href="https://ok-data.github.io/resume/resume_kr">About</a></div><div class="navbar-end"><a class="navbar-item is-hidden-tablet catalogue" title="카탈로그" href="javascript:;"><i class="fas fa-list-ul"></i></a><a class="navbar-item search" title="검색" href="javascript:;"><i class="fas fa-search"></i></a></div></div></div></nav><section class="section"><div class="container"><div class="columns"><div class="column order-2 column-main is-8-tablet is-8-desktop is-8-widescreen"><div class="card"><div class="card-image"><span class="image is-7by3"><img class="thumbnail" src="/assets/thumbnail/5384e25~2.jpg" alt="Object Detection with YOLOv3"></span></div><article class="card-content article" role="article"><div class="article-meta size-small is-uppercase level is-mobile"><div class="level-left"><time class="level-item" dateTime="2018-09-10T15:00:00.000Z" title="2018-09-10T15:00:00.000Z">2018-09-11</time><span class="level-item"><a class="link-muted" href="/categories/Machine-Learning/">Machine Learning</a></span></div></div><h1 class="title is-3 is-size-4-mobile">Object Detection with YOLOv3</h1><div class="content"><!-- 
|  진행날짜  |                           작업내용                           |
| :--------: | :----------------------------------------------------------: |
| 2018/08/14 |               GPU 서버 Host OS (Centos 7) 설치               |
| 2018/08/16 | Nvidia 그래픽 드라이버 설치 / Docker 환경 구성<br/> CUDA Tool kit 컨테이너화, 연동 테스트 |
| 2018/08/17 |     CMake 3.11 컨테이너화 및 테스트<br />Dockerfile 구성     |
| 2018/08/20 |           OpenCV 3.4 컨테이너화 및 GPU 연동 테스트           |
| 2018/08/21 | YOLOv3 컨테이너화 및 소스 코드 빌드<br />weight 데이터 volume mount 테스트<br />테스트 data 실행/결과 확인 |
| 2018/08/22 |  DeepVisionX Player 테스트<br />테스트 data 실행/결과 확인   |
| 2018/08/23 | 수행결과 확인 및 개선방안 점검<br />DeepVisionX Player 테스트<br />Dockerfile 정리 |
| 2018/08/24 |                 수행결과 확인 개선방안 점검                  |
| 2018/08/27 | GPU 서버 Host OS, Ubuntu 16.04 재설치 <br /> OpenCV 환경설정 |
| 2018/08/28 |              Yolov3, DeepVisionX Player 테스트               |
| 2018/08/29 |                Yolo_mark 데이터셋 생성, 학습                 |
| 2018/08/30 |                  개선사항 및 향후 작업 검토                  |
| 2018/09/03 |       번호판 pretrained-weight 데이터 객체인식 테스트        |

------ -->



<table>
<thead>
<tr>
<th>SW dependencies</th>
</tr>
</thead>
<tbody><tr>
<td>NVIDIA Graphic Driver</td>
</tr>
<tr>
<td>CUDA-Toolkit <strong>&gt;= 7.5</strong> (GPGPU 연산)</td>
</tr>
<tr>
<td><strong>5.x &lt;=</strong> cuDNN <strong>&lt;= 7.x</strong> (DL 고성능 연산용)</td>
</tr>
<tr>
<td><strong>3.x &lt;=</strong> OpenCV <strong>&lt;= 3.4.0</strong> (미디어 포맷 인식 및 결과 Grid 그리기)</td>
</tr>
<tr>
<td>CMake <strong>&gt;= 3.8</strong> (C++ 소스코드 빌드)</td>
</tr>
</tbody></table>
<a id="more"></a>

<table>
<thead>
<tr>
<th>Test Environment</th>
<th></th>
</tr>
</thead>
<tbody><tr>
<td>CPU</td>
<td>Intel Xeon(R) CPU E5-2620 16core(8x2) 2.1GHz</td>
</tr>
<tr>
<td>RAM</td>
<td>128G</td>
</tr>
<tr>
<td>GPU</td>
<td>Titan X (Pascal) (*1ea), computer capability : 6.1</td>
</tr>
<tr>
<td>OS</td>
<td>Ubuntu 16.04 (Xenial Xerus)</td>
</tr>
</tbody></table>
<hr>
<h2 id="1-Container화"><a href="#1-Container화" class="headerlink" title="1. Container화"></a>1. Container화</h2><p>테스트 실행에 필요한 환경을 컨테이너로 압축하여 구성한다.</p>
<p>인계받은 자료에 의하면 소스 코드 빌드를 마치고</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./DeepVisionXPlayer [cfg file] [Data cfg file] [weight file] [테스트 미디어 파일]</span><br></pre></td></tr></table></figure>

<p>으로 파일을 실행한다.  </p>
<p>우선 요구환경을 아래와 같이 순서대로 컨테이너화 하여 구축한후</p>
<p><img src="/assets/yolov3/container.PNG" alt="1534743301300"></p>
<p> 아래처럼 [테스트 미디어 파일]을 argument로 설정하여 실행하도록 한다.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run yolo:v1 [테스트 미디어 파일]</span><br></pre></td></tr></table></figure>

<p>컨테이너화 단계 중 <code>OpenCV3.4</code> 를 활용하면 <code>Faster RCNN</code>이나 <code>SSD</code>등의 객체 인식 프레임워크 테스트 환경으로도 활용할 수 있을 것으로 예상된다.</p>
<h3 id="1-1-NVIDA-드라이버-설치"><a href="#1-1-NVIDA-드라이버-설치" class="headerlink" title="1.1 NVIDA 드라이버 설치"></a>1.1 NVIDA 드라이버 설치</h3><p><strong>Nouveau 관련 설정</strong></p>
<p>Linux상에서 NVIDIA 그래픽 드라이버 설치시 nouveau라는 그래픽드라이버가 충돌을 일으키므로 해제하라는 경고 메시지를 만날 수 있다. nouveau는 Linux에 기본적으로 내장된 그래픽 드라이버로 이를 커널로 부터 해제시켜야 정상적으로 설치를 진행할 수 있다.</p>
<p><code>Centos7</code> 상에서는 <code>grub</code>에 설정파일의 <code>GRUB_CMDLINE_LINUX</code>항목 끝에 아래 내용을 입력하여 해결할 수 있다.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">vi /etc/default/grub</span><br><span class="line">---</span><br><span class="line">GRUB_CMDLINE_LINUX=<span class="string">".... rd.driver.blacklist=nouveau nouveau.modeset=0"</span></span><br></pre></td></tr></table></figure>

<p>내용을 입력하였으면 저장<code>wq!</code>하고 커널의 설정을 변경하였으므로 변경된 내용을 아래 명령어로 반영시킨다.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">grub2-mkconfig -o /boot/grub2/grub.cfg</span><br><span class="line"></span><br><span class="line">reboot <span class="comment">## 수정된 커널로 재부팅</span></span><br></pre></td></tr></table></figure>



<p><strong>드라이버 설치</strong></p>
<p>Nvidia 드라이버 홈페이지로 부터 드라이버 설치를 진행한다. 설치할 서버의 GPU 장비에 맞는 버전을 찾아 설치한다.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wget http://kr.download.nvidia.com/XFree86/Linux-x86_64/390.77/NVIDIA-Linux-x86_64-390.77.run</span><br></pre></td></tr></table></figure>

<p>다운로드된 설치파일은 실행권한이 없으므로 아래와 같이 권한을 부여한다.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">chmod a+x NVIDIA-Linux-x86_64-390.77.run</span><br></pre></td></tr></table></figure>

<p>실행권한이 부여되었으므로 설치를 진행한다.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sh NVIDIA-Linux-x86_64-390.77.run</span><br></pre></td></tr></table></figure>



<p>설치가 완료되면 아래 쉘 명령어로 GPU 장비 상태를 확인한다.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nvidia-smi -L</span><br></pre></td></tr></table></figure>

<p><img src="/assets/yolov3/gpu.PNG" alt="GPU 확인"></p>
<h3 id="1-2-Docker-Nvidia-docker-설치"><a href="#1-2-Docker-Nvidia-docker-설치" class="headerlink" title="1.2 Docker / Nvidia-docker 설치"></a>1.2 Docker / Nvidia-docker 설치</h3><p>아래 <code>yum</code> 명령어로 간단하게 docker 설치가 가능하다</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install docker</span><br></pre></td></tr></table></figure>

<p>docker 설치가 완료되면 아래 명령어를 통해 docker가 설치된 정보를 확인할 수 있다.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker info</span><br></pre></td></tr></table></figure>

<p>아래 명령어를 통해 docker로 생성되는 컨테이너들의 위치를 확인할 수 있다.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker info | grep <span class="string">'Docker Root Dir'</span></span><br></pre></td></tr></table></figure>

<p>기본적으로 <code>/var/lib/docker</code>위치에 컨테이너를 생성하는데 컨테이너가 많거나 무거워질 경우를 대비해<br>충분한 공간이 있는 파티션의 디렉토리로 옮기기로 한다.<br>현재 <code>/data</code> 디렉토리에 3TB 하드 두개를 <code>Raid 0</code> 포맷으로 mount 시켰기 때문에 해당 마운트지점에 컨테이너를 저장할 경로를 생성한다.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mkdir /data/docker-img</span><br></pre></td></tr></table></figure>

<p>그 후, docker의 root dir 변경을 위해 아래 처럼 <code>/etc/sysconfig/docker</code> 파일을 열어서</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/sysconfig/docker</span><br></pre></td></tr></table></figure>

<p><code>OPTIONS</code> 값 앞에 아래 처럼 <code>--graph</code>와 <code>--storage-driver</code> 옵션을 추가해준다.</p>
<p>OPTIONS=’–selinux-enabled –log-driver=journald –signature-verification=false <strong>–graph=/data/docker-img –storage-driver=overlay</strong>‘</p>
<p>설정이 변경되었으므로 docker 서비스를 재시작시켜준다.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl restart docker</span><br></pre></td></tr></table></figure>

<p>컨테이너 저장경로가 변경되었는지 확인한다.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker info | grep <span class="string">'Docker Root Dir'</span></span><br></pre></td></tr></table></figure>

<p>테스트를 위해 간단한 컨테이너를 아래 처럼 생성해볼 수 있다.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run hello-world</span><br></pre></td></tr></table></figure>

<p>기본 docker 만으로는 서버에 장착된 그래픽카드를 인식할 수 없다. NVIDIA에서 개발한 <code>NVIDIA-Docker</code>를 이용하여 컨테이너를 생성하면 그래픽카드를 container에서 인식할 수 있다.</p>
<p><strong>NVIDIA-Docker</strong><br>설치는 홈페이지에 나오는 instruction을 따르기로 한다. 아래 쉘 명령어 조합들을 따라서 입력해준다.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">distribution=$(. /etc/os-release;<span class="built_in">echo</span> <span class="variable">$ID</span><span class="variable">$VERSION_ID</span>)</span><br><span class="line">curl -s -L https://nvidia.github.io/nvidia-container-runtime/<span class="variable">$distribution</span>/nvidia-container-runtime.repo | \</span><br><span class="line">sudo tee /etc/yum.repos.d/nvidia-container-runtime.repo</span><br><span class="line">  </span><br><span class="line">sudo yum install -y nvidia-container-runtime-hook</span><br><span class="line">sudo mkdir -p /usr/libexec/oci/hooks.d</span><br><span class="line"><span class="built_in">echo</span> -e <span class="string">'#!/bin/sh\nPATH="/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin" exec nvidia-container-runtime-hook "$@"'</span> | \</span><br><span class="line">sudo tee /usr/libexec/oci/hooks.d/nvidia</span><br><span class="line">sudo chmod +x /usr/libexec/oci/hooks.d/nvidia</span><br></pre></td></tr></table></figure>

<p>입력이 완료되면 아래 docker 명령어로 docker상에서 <code>nvidia-smi</code>명령어 실행을 확인할 수 있다.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run --rm nvidia/cuda nvidia-smi</span><br></pre></td></tr></table></figure>

<p><img src="/assets/yolov3/nvidia-smi.PNG" alt="nvidia-smi"></p>
<h3 id="1-3-CUDA-9-x-및-cudnn7-컨테이너화"><a href="#1-3-CUDA-9-x-및-cudnn7-컨테이너화" class="headerlink" title="1.3 CUDA (9.x) 및 cudnn7 컨테이너화"></a>1.3 CUDA (9.x) 및 cudnn7 컨테이너화</h3><p>Public Registry인 Docker Hub로 부터 CUDA 및 cudnn이 설치된 컨테이너를 pull할 수 있다.<br><img src="/assets/yolov3/2.PNG" alt="docker-image"><br>현재 테스트를 위해서 <code>9.0-cudnn7-runtime</code> 버전의 이미지를 생성하도록한다.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker pull nvidia/cuda:9.0-cudnn7-devel-ubuntu16.04</span><br></pre></td></tr></table></figure>

<p>생성된 이미지로 컨테이너를 생성하여 <code>bash</code>터미널로 접속한다.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run -it nvidia/cuda:9.0-cudnn7-devel-ubuntu16.04 /bin/bash</span><br></pre></td></tr></table></figure>

<p>컨테이너의 OS버전과 그래픽드라이버를 확인한다.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cat /os-release</span><br><span class="line">nvidia-smi</span><br></pre></td></tr></table></figure>

<p><img src="/assets/yolov3/smi.PNG" alt="1535072727090"></p>
<p>CUDA 설치를 위해선 아래 명령어를 입력한다.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nvcc -V</span><br></pre></td></tr></table></figure>

<p><img src="/assets/yolov3/3.PNG" alt="nvcc"></p>
<h3 id="1-4-CMake-컨테이너화"><a href="#1-4-CMake-컨테이너화" class="headerlink" title="1.4 CMake 컨테이너화"></a>1.4 CMake 컨테이너화</h3><p>컨테이너 나가기: <code>shift</code>+<code>p</code> + <code>shift</code>+<code>q</code></p>
<p><code>YOLOv3</code>이 CMake 3.8+ 이상의 버전을 요구하므로 공식 release 버전중 하나인 <code>3.11.4</code>버전을 설치해본다.<br>아래처럼 Dockerfile 파일을 생성한다.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">mkdir cmake-docker</span><br><span class="line"><span class="built_in">cd</span> cmake-docker</span><br><span class="line">vi Dockerfile</span><br></pre></td></tr></table></figure>

<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">FROM</span> nvidia/cuda:<span class="number">9.0</span>-cudnn7-devel</span><br><span class="line"></span><br><span class="line"><span class="comment">## change here for diff version</span></span><br><span class="line"><span class="keyword">ENV</span> CMAKE_VERSION=<span class="number">3.11</span>.<span class="number">4</span></span><br><span class="line"></span><br><span class="line"><span class="comment">## Cmake</span></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> apt-get update -y &amp;&amp; apt-get upgrade -y \</span></span><br><span class="line"><span class="bash">    &amp;&amp; apt-get install curl wget unzip -y \</span></span><br><span class="line"><span class="bash">    &amp;&amp; curl https://cmake.org/files/v3.11/cmake-<span class="variable">$&#123;CMAKE_VERSION&#125;</span>-Linux-x86_64.sh -o /tmp/curl-install.sh \</span></span><br><span class="line"><span class="bash">    &amp;&amp; chmod u+x /tmp/curl-install.sh \</span></span><br><span class="line"><span class="bash">    &amp;&amp; mkdir /usr/bin/cmake \</span></span><br><span class="line"><span class="bash">    &amp;&amp; /tmp/curl-install.sh --skip-license --prefix=/usr/bin/cmake \</span></span><br><span class="line"><span class="bash">    &amp;&amp; rm /tmp/curl-install.sh</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">ENV</span> PATH=<span class="string">"/usr/bin/cmake/bin:$&#123;PATH&#125;"</span></span><br></pre></td></tr></table></figure>

<p><code>docker build</code> 명령을 통해 작성한 Dockerfile로 이미지를 생성한다.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker build [Dockerfile 경로] -t [이미지명]:[태그]</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker build cmake-docker -t cmake:3.11.4</span><br></pre></td></tr></table></figure>

<p>생성된 이미지로 cmake 버전을 확인한다.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run -it --rm cmake:3.11.4 cmake --version</span><br></pre></td></tr></table></figure>





<h3 id="1-4-OpenCV-컨테이너화"><a href="#1-4-OpenCV-컨테이너화" class="headerlink" title="1.4 OpenCV 컨테이너화"></a>1.4 OpenCV 컨테이너화</h3><p>디렉토리를 새로 생성하여 아래와 같이 Dockerfile을 만든다.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mkdir opencv-docker</span><br><span class="line"><span class="built_in">cd</span> docker &amp;&amp; vi Dockerfile</span><br></pre></td></tr></table></figure>

<p>OpenCV의 버전은 3.4.0을 설치한다.</p>
<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">FROM</span> cmake:<span class="number">3.11</span>.<span class="number">4</span></span><br><span class="line"></span><br><span class="line"><span class="comment">## change here to diff version</span></span><br><span class="line"><span class="keyword">ENV</span> OPENCV_VER=<span class="number">3.4</span>.<span class="number">0</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> apt-get update</span></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> apt-get install -y \</span></span><br><span class="line"><span class="bash">    wget \</span></span><br><span class="line"><span class="bash">    git \</span></span><br><span class="line"><span class="bash">    unzip \</span></span><br><span class="line"><span class="bash">    build-essential \</span></span><br><span class="line"><span class="bash">    curl \</span></span><br><span class="line"><span class="bash">    <span class="comment">## For OpenCV</span></span></span><br><span class="line">    libgtk2.<span class="number">0</span>-dev \</span><br><span class="line">    pkg-config \</span><br><span class="line">    libavcodec-dev \</span><br><span class="line">    libavformat-dev \</span><br><span class="line">    libswscale-dev</span><br><span class="line"></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> apt-get clean</span></span><br><span class="line"></span><br><span class="line"><span class="comment">## Change Directory</span></span><br><span class="line"><span class="keyword">WORKDIR</span><span class="bash"> /tmp</span></span><br><span class="line"></span><br><span class="line"><span class="comment">## build and install OpenCV</span></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> wget https://github.com/opencv/opencv/archive/<span class="variable">$&#123;OPENCV_VER&#125;</span>.zip</span></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> unzip <span class="variable">$&#123;OPENCV_VER&#125;</span>.zip</span></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> mkdir opencv-<span class="variable">$&#123;OPENCV_VER&#125;</span>/build</span></span><br><span class="line"><span class="keyword">WORKDIR</span><span class="bash"> opencv-<span class="variable">$&#123;OPENCV_VER&#125;</span>/build</span></span><br><span class="line"></span><br><span class="line"><span class="comment">## lets do this</span></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> cmake \</span></span><br><span class="line"><span class="bash">-D CMAKE_BUILD_TYPE=Release \</span></span><br><span class="line"><span class="bash">-D CMAKE_INSTALL_PREFIX=/usr/<span class="built_in">local</span> \</span></span><br><span class="line"><span class="bash">-D BUILD_CUDA_STUBS=OFF \</span></span><br><span class="line"><span class="bash">-D BUILD_DOCS=OFF \</span></span><br><span class="line"><span class="bash">-D BUILD_EXAMPLES=OFF \</span></span><br><span class="line"><span class="bash">-D BUILD_JASPER=OFF \</span></span><br><span class="line"><span class="bash">-D BUILD_JPEG=OFF \</span></span><br><span class="line"><span class="bash">-D BUILD_OPENEXR=OFF \</span></span><br><span class="line"><span class="bash">-D BUILD_PACKAGE=ON \</span></span><br><span class="line"><span class="bash">-D BUILD_PERF_TESTS=OFF \</span></span><br><span class="line"><span class="bash">-D BUILD_PNG=OFF \</span></span><br><span class="line"><span class="bash">-D BUILD_SHARED_LIBS=ON \</span></span><br><span class="line"><span class="bash">-D BUILD_TBB=OFF \</span></span><br><span class="line"><span class="bash">-D BUILD_TESTS=OFF \</span></span><br><span class="line"><span class="bash">-D BUILD_TIFF=OFF \</span></span><br><span class="line"><span class="bash">-D BUILD_WITH_DEBUG_INFO=ON \</span></span><br><span class="line"><span class="bash">-D BUILD_ZLIB=OFF \</span></span><br><span class="line"><span class="bash">-D BUILD_WEBP=OFF \</span></span><br><span class="line"><span class="bash">-D BUILD_opencv_apps=ON \</span></span><br><span class="line"><span class="bash">-D BUILD_opencv_calib3d=ON \</span></span><br><span class="line"><span class="bash">-D BUILD_opencv_core=ON \</span></span><br><span class="line"><span class="bash">-D BUILD_opencv_cudaarithm=OFF \</span></span><br><span class="line"><span class="bash">-D BUILD_opencv_cudabgsegm=OFF \</span></span><br><span class="line"><span class="bash">-D BUILD_opencv_cudacodec=OFF \</span></span><br><span class="line"><span class="bash">-D BUILD_opencv_cudafeatures2d=OFF \</span></span><br><span class="line"><span class="bash">-D BUILD_opencv_cudafilters=OFF \</span></span><br><span class="line"><span class="bash">-D BUILD_opencv_cudaimgproc=OFF \</span></span><br><span class="line"><span class="bash">-D BUILD_opencv_cudalegacy=OFF \</span></span><br><span class="line"><span class="bash">-D BUILD_opencv_cudaobjdetect=OFF \</span></span><br><span class="line"><span class="bash">-D BUILD_opencv_cudaoptflow=OFF \</span></span><br><span class="line"><span class="bash">-D BUILD_opencv_cudastereo=OFF \</span></span><br><span class="line"><span class="bash">-D BUILD_opencv_cudawarping=OFF \</span></span><br><span class="line"><span class="bash">-D BUILD_opencv_cudev=OFF \</span></span><br><span class="line"><span class="bash">-D BUILD_opencv_features2d=ON \</span></span><br><span class="line"><span class="bash">-D BUILD_opencv_flann=ON \</span></span><br><span class="line"><span class="bash">-D BUILD_opencv_highgui=ON \</span></span><br><span class="line"><span class="bash">-D BUILD_opencv_imgcodecs=ON \</span></span><br><span class="line"><span class="bash">-D BUILD_opencv_imgproc=ON \</span></span><br><span class="line"><span class="bash">-D BUILD_opencv_java=OFF \</span></span><br><span class="line"><span class="bash">-D BUILD_opencv_ml=ON \</span></span><br><span class="line"><span class="bash">-D BUILD_opencv_objdetect=ON \</span></span><br><span class="line"><span class="bash">-D BUILD_opencv_photo=ON \</span></span><br><span class="line"><span class="bash">-D BUILD_opencv_python2=OFF \</span></span><br><span class="line"><span class="bash">-D BUILD_opencv_python3=OFF \</span></span><br><span class="line"><span class="bash">-D BUILD_opencv_shape=ON \</span></span><br><span class="line"><span class="bash">-D BUILD_opencv_stitching=ON \</span></span><br><span class="line"><span class="bash">-D BUILD_opencv_superres=ON \</span></span><br><span class="line"><span class="bash">-D BUILD_opencv_ts=ON \</span></span><br><span class="line"><span class="bash">-D BUILD_opencv_video=ON \</span></span><br><span class="line"><span class="bash">-D BUILD_opencv_videoio=ON \</span></span><br><span class="line"><span class="bash">-D BUILD_opencv_videostab=ON \</span></span><br><span class="line"><span class="bash">-D BUILD_opencv_viz=OFF \</span></span><br><span class="line"><span class="bash">-D BUILD_opencv_world=OFF \</span></span><br><span class="line"><span class="bash">-D CMAKE_BUILD_TYPE=RELEASE \</span></span><br><span class="line"><span class="bash">-D WITH_1394=ON \</span></span><br><span class="line"><span class="bash">-D WITH_CUBLAS=OFF \</span></span><br><span class="line"><span class="bash">-D WITH_CUDA=OFF \</span></span><br><span class="line"><span class="bash">-D WITH_CUFFT=OFF \</span></span><br><span class="line"><span class="bash">-D WITH_EIGEN=ON \</span></span><br><span class="line"><span class="bash">-D WITH_FFMPEG=OFF \</span></span><br><span class="line"><span class="bash">-D WITH_GDAL=OFF \</span></span><br><span class="line"><span class="bash">-D WITH_GPHOTO2=OFF \</span></span><br><span class="line"><span class="bash">-D WITH_GIGEAPI=ON \</span></span><br><span class="line"><span class="bash">-D WITH_GSTREAMER=ON \</span></span><br><span class="line"><span class="bash">-D WITH_GTK=ON \</span></span><br><span class="line"><span class="bash">-D WITH_INTELPERC=OFF \</span></span><br><span class="line"><span class="bash">-D WITH_IPP=ON \</span></span><br><span class="line"><span class="bash">-D WITH_IPP_A=OFF \</span></span><br><span class="line"><span class="bash">-D WITH_JASPER=OFF \</span></span><br><span class="line"><span class="bash">-D WITH_JPEG=ON \</span></span><br><span class="line"><span class="bash">-D WITH_LIBV4L=OFF \</span></span><br><span class="line"><span class="bash">-D WITH_OPENCL=ON \</span></span><br><span class="line"><span class="bash">-D WITH_OPENCLAMDBLAS=OFF \</span></span><br><span class="line"><span class="bash">-D WITH_OPENCLAMDFFT=OFF \</span></span><br><span class="line"><span class="bash">-D WITH_OPENCL_SVM=OFF \</span></span><br><span class="line"><span class="bash">-D WITH_OPENEXR=OFF \</span></span><br><span class="line"><span class="bash">-D WITH_OPENGL=ON \</span></span><br><span class="line"><span class="bash">-D WITH_OPENMP=OFF \</span></span><br><span class="line"><span class="bash">-D WITH_OPENNI=OFF \</span></span><br><span class="line"><span class="bash">-D WITH_PNG=ON \</span></span><br><span class="line"><span class="bash">-D WITH_PTHREADS_PF=OFF \</span></span><br><span class="line"><span class="bash">-D WITH_PVAPI=ON \</span></span><br><span class="line"><span class="bash">-D WITH_QT=OFF \</span></span><br><span class="line"><span class="bash">-D WITH_TBB=ON \</span></span><br><span class="line"><span class="bash">-D WITH_TIFF=OFF \</span></span><br><span class="line"><span class="bash">-D WITH_UNICAP=OFF \</span></span><br><span class="line"><span class="bash">-D WITH_V4L=OFF \</span></span><br><span class="line"><span class="bash">-D WITH_VTK=OFF \</span></span><br><span class="line"><span class="bash">-D WITH_WEBP=OFF \</span></span><br><span class="line"><span class="bash">-D WITH_XIMEA=OFF \</span></span><br><span class="line"><span class="bash">-D WITH_XINE=OFF \</span></span><br><span class="line"><span class="bash">..</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> cmake --build . --config Release</span></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> make -j<span class="variable">$&#123;nproc&#125;</span> install</span></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> <span class="built_in">cd</span> /</span></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> rm -rf /tmp/*</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># config path</span></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> LD_LIBRARY_PATH=/usr/<span class="built_in">local</span>/lib:/usr/lib; <span class="built_in">export</span> LD_LIBRARY_PATH</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> ldconfig</span></span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker build opencv-docker -t opencv:3.4.0</span><br></pre></td></tr></table></figure>

<p>여기까지가 컨테이너상에 <code>CUDA</code> + <code>CUDNN</code> + <code>Cmake</code> + <code>Opencv</code> 를 설치하는 과정이다.<br>이제 <code>YOLOv3</code>의 소스를 받아 실행해본다.</p>
<h3 id="1-5-YOLOv3"><a href="#1-5-YOLOv3" class="headerlink" title="1.5 YOLOv3"></a>1.5 YOLOv3</h3><p><code>Opencv</code>컨테이너를 생성하여 쉘로 접속한다.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run -it --rm opencv:3.4.0 /bin/bash</span><br></pre></td></tr></table></figure>

<p>아래 명령어를 통해 Yolov3를 깃허브로부터 받는다.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git <span class="built_in">clone</span> https://github.com/AlexeyAB/darknet.git</span><br></pre></td></tr></table></figure>

<p>다운로드가 끝나면 이제 빌드를 해야하는데 <code>Makefile</code>를 편집기로 열어서 (vi 없으면 설치..) 수정해준다.<br>맨 상단에 <code>GPU</code>,<code>CUDNN</code>, <code>OPENCV</code>등의 옵션이 <code>0</code>으로 지정되어 있는데 이들을 <code>1</code>로 수정해준다.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">GPU=1</span><br><span class="line">CUDNN=1</span><br><span class="line">CUDNN_HALF=0</span><br><span class="line">OPENCV=1</span><br><span class="line">AVX=0</span><br><span class="line">OPENMP=0</span><br><span class="line">LIBSO=0</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<p><code>darknet</code>폴더로 이동하여 빌드를 아래 명령어로 수행한다.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> darknet</span><br><span class="line">make -j<span class="variable">$&#123;nproc&#125;</span></span><br></pre></td></tr></table></figure>

<p>빌드가 끝나면 <code>weight</code>파일을 생성해야하는데 학습된 <code>weight</code> 샘플을 아래처럼 받을 수 있다.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wget https://pjreddie.com/media/files/yolov3.weights</span><br></pre></td></tr></table></figure>

<p>가중치에 대한 <code>cfg</code>는 소스에 포함되어 있으므로 아래처럼 <code>data</code>폴더 밑의 <code>dog.jpg</code>이미지에 대학 객체 인식을 수행한다.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./darknet detect cfg/yolo.cfg yolov3.weights data/dog.jpg</span><br></pre></td></tr></table></figure>

<p><img src="/assets/yolov3/dog.PNG" alt="dog"><br>결과를 조회해보면 JPG 파일 하나에서 객체를 추측하는데 <code>0.02</code>초 정도로 나타난다.<br>또한 인식한 객체들에 대한 결과가 나타나고 Grid된 좌표에 대한 결과가 나타난다.</p>
<p>마지막에 <code>GTK</code> 경고가 나타나는데 이는 이미지를 보여줄 <code>Window</code>환경이나 <code>Display</code>가 찾을 수 없음을 의미한다.</p>
<p>경고 메시지가 닫히면 로컬에 <code>predictions.png</code>파일이 생성되고 수행결과를 확인해볼 수 있다.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ls ./</span><br></pre></td></tr></table></figure>

<p><img src="/assets/yolov3/5.PNG" alt="list"></p>
<p><img src="/assets/yolov3/predictions.jpg" alt="predictions"></p>
<p>단일 이미지파일에 대해서는 객체인식을 하는것으로 나타나므로 <code>Video</code>파일에 대한 객체인식을 수행한다.<br>테스트할 Video데이터는 <code>carpark.mp4</code>로 주차장 녹화 데이터이다.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/darknet detector demo cfg/coco.data cfg/yolov3.cfg /tmp/yolov3.weights /tmp/carpark.mp4</span><br></pre></td></tr></table></figure>

<p><img src="/assets/yolov3/6.PNG" alt="list"><br>뉴럴네트워크 구성에는 성공하였으나 Video 스트림에는 실패한것으로 보인다.</p>
<p>로컬에서도 파일생성에 실패한것으로 나타난다.</p>
<h3 id="1-6-DeepVisionX-Player-테스트"><a href="#1-6-DeepVisionX-Player-테스트" class="headerlink" title="1.6 DeepVisionX Player 테스트"></a>1.6 DeepVisionX Player 테스트</h3><p>DeepVisionX Player는 darknet 라이브러리를 이용하여 OpenCV 및 CUDA를 사용하여 YOLOv3으로 동영상, /assets\yolov3으로부터 실시간 객체를 탐지하는 프로그램이다.</p>
<p>인계받은 DeepVisionX Player의 소스코드를 container로 옮긴다.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cp -r /tmp/deep-vision-x-player/ /</span><br></pre></td></tr></table></figure>

<p>빌드를 위해 <code>build</code>디렉토리를 생성하고 컴파일을 진행한다.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">mkdir build</span><br><span class="line"><span class="built_in">cd</span> build </span><br><span class="line">cmake ..</span><br><span class="line">make -j<span class="variable">$&#123;nproc&#125;</span></span><br></pre></td></tr></table></figure>

<p>빌드에 성공하였다면 video 파일에 대한 객체인식을 진행하고 명령어 입력 방식은 아래와 동일하다</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">build/bin/DeepVisionXPlayer [yolo cfg 파일] [train cfg 파일] [수행할 video 파일]</span><br></pre></td></tr></table></figure>

<p>테스트를 위해 실행한 명령어는 아래와 같다</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">## 소스파일 디렉토리로 이동한다.</span></span><br><span class="line"><span class="built_in">cd</span> /deep-vision-x-player</span><br><span class="line"></span><br><span class="line">build/bin/DeepVisionXPlayer cfg/yolov3.cfg cfg/coco.data /tmp/yolov3.weights carpark.mp4</span><br></pre></td></tr></table></figure>

<p>수행결과:</p>
<p><img src="C:%5CUsers%5CKHKim%5CAppData%5CLocal%5CTemp%5C1535101449810.png" alt="1535101449810"></p>
<p>마찬가지로 뉴럴 네트워크 구성에는 성공하였으나 video 파일 인식에는 실패하였다.</p>
<h2 id="2-Ubuntu-16-04-Desktop"><a href="#2-Ubuntu-16-04-Desktop" class="headerlink" title="2. Ubuntu 16.04 Desktop"></a>2. Ubuntu 16.04 Desktop</h2><p>GPU서버의 Host OS를 <code>Ubuntu 16.04</code>로 재설치하여 진행한다.</p>
<p>OpenCV, Nvidia 그래픽 드라이버를 잡는 방법은 컨테이너화 작업때의 스크립트를 재사용하고<br>CUDA-Toolkit, cuDNN 설치는 추가적인 작업을 진행하도록 한다.</p>
<h3 id="2-1-CUDA-ToolKit-9-0-cuDNN-7-설치"><a href="#2-1-CUDA-ToolKit-9-0-cuDNN-7-설치" class="headerlink" title="2.1 CUDA-ToolKit 9.0, cuDNN 7 설치"></a>2.1 CUDA-ToolKit 9.0, cuDNN 7 설치</h3><p>우선 CUDA-Toolkit을 설치하는데 최신 버전인 <code>9.2</code>버전을 설치하지 않고 <code>9.0</code> 버전을 설치한다.</p>
<p>아래 그림과 같이 Ubuntu 16.04 버전에 해당하는 설치파일을 다운로드 받는다.<br><img src="https://drive.google.com/uc?id=1TOxreAWVJWxCgCHbD3wz0iBq9aJ0WNzz" alt="NVIDIA"></p>
<p>다운로드한 CUDA 설치 파일 경로로 이동하여 실행시킵니다.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> ~/Downloads</span><br><span class="line"></span><br><span class="line">chmod a+x cuda_9.0~.run</span><br><span class="line">sudo sh cuda_9.0~.run</span><br></pre></td></tr></table></figure>

<p>설명문이 나오면 Enter 혹은 space 를 입력하여 끝까지 읽고 (Ctrl + c 로 스킵 가능) 다음처럼 진행</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">&quot;&quot;Do you accept the previously read EULA? accept&#x2F;decline&#x2F;quit:  accept</span><br><span class="line"></span><br><span class="line">Install NVIDIA Accelerated Graphics Driver for Linux-x86_64 384.81? ((y)es &#x2F;(n)o&#x2F;(q)uit) : n</span><br><span class="line"></span><br><span class="line">Do you want to install the OpenGL libraries? ((y)es &#x2F;(n)o&#x2F;(q)uit) : n</span><br><span class="line"></span><br><span class="line">Do you want to run nvidia-xconfig?</span><br><span class="line">This will update the system X configuration file so that the NVIDIA X driver</span><br><span class="line">is used. The pre-existing X configuration file will be backed up.</span><br><span class="line">This option should not be used on systems that require a custom</span><br><span class="line">X configuration, such as systems with multiple GPU vendors.</span><br><span class="line"></span><br><span class="line">((y)es &#x2F;(n)o&#x2F;(q)uit) : n</span><br><span class="line"></span><br><span class="line">Install the CUDA 9.0 Toolkit? ((y)es &#x2F;(n)o&#x2F;(q)uit) : y</span><br><span class="line"></span><br><span class="line">Enter Toolkit Location</span><br><span class="line">[ default is &#x2F;usr&#x2F;local&#x2F;cuda-9.0 ] : Enter</span><br><span class="line"></span><br><span class="line">Do you want to install a symbolic link at &#x2F;usr&#x2F;local&#x2F;cuda? ((y)es &#x2F;(n)o&#x2F;(q)uit) : y</span><br><span class="line"></span><br><span class="line">Install the CUDA 9.0 Samples?</span><br><span class="line">(y)es&#x2F;(n)o&#x2F;(q)uit: n</span><br></pre></td></tr></table></figure>

<p>다음으로 cuDNN 설치로 진행한다.</p>
<p>cuDNN은 Cuda Deep Neural Network 의 약자로 CUDA에서 인공신경망 구조를 생성할 수 있도록 지원하는 NVIDIA에서 제공하는 라이브러리입니다.</p>
<p>NVIDIA의 cuDNN 다운로드 링크를 접속하여 간단한 멤버십 가입을 통해 다운로드를 진행합니다.</p>
<p>다운로드 URL : <a href="https://developer.nvidia.com/rdp/cudnn-download">https://developer.nvidia.com/rdp/cudnn-download</a></p>
<p>CUDA 9.0 버전의 제일 상단의 cuDNN v7.1.4 Library for Linux 을 선택하여 다운로드합니다. (tgz  파일)</p>
<p><img src="https://drive.google.com/uc?id=1PX1ESLTfvui_wQLMqGm4jLHKYtZsb-MO" alt="NVIDIA cuDNN"></p>
<p>다운로드 받은 파일 경로로 이동하여 압축을 해제합니다.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> Downloads</span><br><span class="line"></span><br><span class="line">tar xvf cudnn-9.0-linux-x64-v7.1.tgz</span><br></pre></td></tr></table></figure>

<p>압축을 해제하면 cuda 폴더가 생성되는데, 내부 파일들을 다음과 같이 복사합니다.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sudo cp cuda/include/cudnn.h /usr/<span class="built_in">local</span>/cuda/include</span><br><span class="line">sudo cp cuda/lib64/libcudnn* /usr/<span class="built_in">local</span>/cuda/lib64</span><br><span class="line">sudo chmod a+x /usr/<span class="built_in">local</span>/cuda/include/cudnn.h /usr/<span class="built_in">local</span>/cuda/lib64/libcudnn*</span><br></pre></td></tr></table></figure>

<p>모든 과정이 끝나면 홈디렉토리로 이동하여 .bashrc 파일에 CUDA의 PATH를 등록합니다.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">sudo vi ~/.bashrc</span><br><span class="line"></span><br><span class="line"><span class="built_in">export</span> PATH=/usr/<span class="built_in">local</span>/cuda/bin<span class="variable">$&#123;PATH:+:$&#123;PATH&#125;</span>&#125;</span><br><span class="line"><span class="built_in">export</span> LD_LIBRARY_PATH=/usr/<span class="built_in">local</span>/cuda/lib64<span class="variable">$&#123;LD_LIBRARY_PATH:+:$&#123;LD_LIBRARY_PATH&#125;</span>&#125;</span><br></pre></td></tr></table></figure>

<p>내용을 저장하고 닫습니다. </p>
<p>bashrc의 변경사항을 바로 반영하도록 다음 명령을 실행합니다.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">source</span> ~/.bashrc</span><br></pre></td></tr></table></figure>

<p>설치가 잘 완료되었는지 확인하기 위해 <code>nvcc -V</code>를 통해 CUDA 버전을 확인할 수 있습니다.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nvcc -V</span><br></pre></td></tr></table></figure>





<h3 id="2-2-YOLO-mark를-이용한-데이터-labeling"><a href="#2-2-YOLO-mark를-이용한-데이터-labeling" class="headerlink" title="2.2 YOLO_mark를 이용한 데이터 labeling"></a>2.2 YOLO_mark를 이용한 데이터 labeling</h3><p><code>souce : /home/kipang/workspace/Yolo_mark</code></p>
<p>기존의 coco dataset, 80개의 클래스의 객체인식외에 Custom으로 클래스 데이터셋을 생성하는 작업을 진행합니다.</p>
<p><code>Yolo_mark</code>는 custom 데이터를 생성하기 위한 marking 툴을 제공합니다.<br><code>git</code>명령을 통해 다음과 같이 github의 <code>yolo-mark</code>오픈소스를 <code>git clone</code>하여 빌드합니다.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">git <span class="built_in">clone</span> https://github.com/AlexeyAB/Yolo_mark.git</span><br><span class="line"><span class="built_in">cd</span> Yolo_mark</span><br><span class="line">cmake .</span><br><span class="line">make</span><br></pre></td></tr></table></figure>

<p>빌드가 끝나면 <code>yolo_mark</code> 바이너리 실행파일이 생성된 것을 확인한다.</p>
<p><code>x64/Release/data/obj.data</code>파일을 편집기로 열어서 학습될 객체의 갯수를 지정해준다.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vi x64/Release/data/obj.data</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">classes=2				  <span class="comment">## 클래스 갯수</span></span><br><span class="line">train = data/train.txt 	  <span class="comment">## train 대상파일</span></span><br><span class="line">valid = data/valid.txt 	  <span class="comment">## validation 파일</span></span><br><span class="line">names = data/obj.names 	  <span class="comment">## 객체명</span></span><br><span class="line">backup = /path/to/bakcup  <span class="comment">## weight 저장위치</span></span><br></pre></td></tr></table></figure>

<p><code>train</code>, <code>valid</code>는 각각 학습,검증에 사용될 이미지파일의 경로를 가지고 있어야한다.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">예시)</span><br><span class="line">vi train.txt</span><br><span class="line">-------------------</span><br><span class="line">/path/to/cat1.jpg</span><br><span class="line">/path/to/cat2.jpg</span><br><span class="line">/path/to/cat3.jpg</span><br><span class="line">/path/to/dog1.jpg</span><br><span class="line">....</span><br></pre></td></tr></table></figure>

<p>obj.names 파일에는 객체명을 저장한다.</p>
<figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">예시)</span><br><span class="line"><span class="keyword">vi</span> obj.names</span><br><span class="line">-------------------</span><br><span class="line"><span class="keyword">cat</span></span><br><span class="line">dog</span><br></pre></td></tr></table></figure>

<p>위와 같이 <code>.jpg</code> 학습파일, <code>train.txt</code> 이미지경로, <code>obj.names</code>의 작업이 끝나면<br>아래와 같이 argument를 주어 <code>yolo-mark</code>를 실행한다.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">yolo_mark &lt;JPG파일 경로&gt; &lt;train.txt 경로&gt; &lt;obj.names 경로&gt;</span><br><span class="line">예) yolo_mark /path/jpg/ /path/to/train.txt /path/to/obj.names</span><br></pre></td></tr></table></figure>

<p>실행하게 되면 아래 그림처럼 labeling 작업 툴 화면이 나타나게 된다.</p>
<p><strong>실행화면:</strong></p>
<p><img src="/assets/yolov3/img.PNG" alt="yolo-mark"></p>
<p>Keymap:</p>
<table>
<thead>
<tr>
<th align="center">Key</th>
<th align="center">동작</th>
</tr>
</thead>
<tbody><tr>
<td align="center">마우스 드래그 &amp; 드롭</td>
<td align="center">box 그리기</td>
</tr>
<tr>
<td align="center">숫자키 0~9, ←,→</td>
<td align="center">객체 id 지정</td>
</tr>
<tr>
<td align="center">space</td>
<td align="center">다음 /assets\yolov3</td>
</tr>
<tr>
<td align="center">c</td>
<td align="center">모든 box 지우기</td>
</tr>
<tr>
<td align="center">z</td>
<td align="center">취소,undo</td>
</tr>
<tr>
<td align="center">ESC</td>
<td align="center">종료</td>
</tr>
</tbody></table>
<p>여러 객체가 있을때 숫자키, 좌우키로 객체 id를 변환하면서 지정할 수도 있다.</p>
<p><img src="/assets/yolov3/cat-dog.PNG" alt="cat-dog"></p>
<p>Box를 지정할때 마다 <code>jpg</code> 폴더에 해당파일의 <code>.txt</code>가 생성되며 내용에는</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">객체id &lt;x&gt; &lt;y&gt; &lt;width&gt; &lt;height&gt;</span><br></pre></td></tr></table></figure>

<p>처럼 box 작업을 한 내역이 저장되어 있다.</p>
<p>Custom 데이터생성은 <code>Yolo_mark</code>를 사용하거나 <code>LabelImg</code> : <a href="https://github.com/tzutalin/labelImg">https://github.com/tzutalin/labelImg</a> 으로도 작업할 수 있다.</p>
<h4 id="2-2-1-Video-frame-저장"><a href="#2-2-1-Video-frame-저장" class="headerlink" title="2.2.1 Video frame 저장"></a>2.2.1 Video frame 저장</h4><p><code>yolo_mark</code>에서는 Video 파일의 <strong>특정 N frame마다 JPG Image</strong>로 저장하는 기능을 제공한다.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./yolo_mark &lt;프레임 저장경로&gt; cap_video &lt;Video파일&gt; &lt;N&gt;</span><br></pre></td></tr></table></figure>

<p>N을 10으로 지정하면 10번째 프레임마다 지정한 경로에 <code>JPG</code>로 저장된다.<br>저장된 프레임 데이터에 labeling 작업을 진행하여 학습데이터로 활용할 수 있다.</p>
<h3 id="2-3-Custom-데이터셋-학습"><a href="#2-3-Custom-데이터셋-학습" class="headerlink" title="2.3 Custom 데이터셋 학습"></a>2.3 Custom 데이터셋 학습</h3><h4 id="2-3-1-Preparation"><a href="#2-3-1-Preparation" class="headerlink" title="2.3.1 Preparation"></a>2.3.1 Preparation</h4><p>custom 데이터셋으로 학습을 진행하기 위해 앞서 진행하던 <code>Yolo-mark</code>의 <code>x64/Release/yolo-obj.cfg</code>파일을 수정한다.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vi x64/Release/yolo-obj.cfg</span><br></pre></td></tr></table></figure>

<p>내용 하단의 <code>244줄</code>, <code>230줄</code> 두 부분을 수정해야 한다.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[convolutional]</span><br><span class="line">...</span><br><span class="line"><span class="comment">##224줄</span></span><br><span class="line">filters=21</span><br><span class="line">...</span><br><span class="line"></span><br><span class="line">[region]</span><br><span class="line">...</span><br><span class="line"><span class="comment">###230줄</span></span><br><span class="line">classes=2</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<p><code>filters</code>에 <code>convolutional</code>레이어의 필터값을 넣는데 다음과 같은 식에 따라 입력해준다.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Yolov2 : (클래스수 + 5) x 5   ex) 클래스: 2, filter : 35</span><br><span class="line">Yolov3 : (클래스수 + 5) x 3</span><br></pre></td></tr></table></figure>

<p><code>classes</code>에는 클래스 갯수를 입력해준다.</p>
<p>다음으로 <code>darknet</code>을 실행할 수 있는 경로로 이동하여 아래와 같이 학습을 진행한다.</p>
<h4 id="2-3-2-Training"><a href="#2-3-2-Training" class="headerlink" title="2.3.2 Training"></a>2.3.2 Training</h4><p><code>convolutional layer</code>를 구성하기 위해 사전에 학습된 가중치 데이터를 다운로드 받는다. (76MB)</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wget http://pjreddie.com/media/files/darknet19_448.conv.23</span><br></pre></td></tr></table></figure>

<p>다운로드가 끝나면 custom dataset 레이블링 작업에 사용된 <code>obj.data</code>,<code>obj.names</code>,<code>train.txt</code>, <code>darknet19_448.conv.23</code> 파일을 <code>darknet</code> 실행경로로 옮겨준다.</p>
<p>아래와 같이 <code>darknet detector train</code>명령을 통해 학습을 실행시킨다.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">darknet detector train data/obj.data cfg/yolo-obj.cfg darknet19_448.conv.23 -dont_show</span><br></pre></td></tr></table></figure>

<p><img src="/assets/yolov3/avg-loss.PNG" alt="avg-loss"></p>
<p>학습을 진행하면 위 그림과 같이 학습단계가 log형식으로 터미널상에 뿌려지는데<br>왼쪽부터가 <code>학습 iteration</code> 횟수, <code>avg loss</code> 가 error rate 이다. </p>
<p>Yolo document 에 따르면 <strong>클래스당</strong> 적어도 <strong>2000</strong> 번의 <code>iteration</code>을 수행해야한다고 나타나있다.<br>즉, <strong>클래스가 3종류</strong>이면 적어도 3 x 2000=<strong>6000</strong>번 정도의 <code>iteration</code>을 진행해야 한다.</p>
<p>또한 <code>avg loss</code>는 0.xxxxx 이하로 나타날때 Overfitting이 발생할 수 있으므로 해당 수치정도까지 학습을 진행하도록 권장되어있다.</p>
<p>학습은 100번의 iteration 마다 <code>obj.data</code>에 명시해둔 <code>backup</code> 경로에 checkpoint 형식으로 저장된다.</p>
<p><img src="/assets/yolov3/backup.PNG" alt="backup"></p>
<p>학습도중 예기치 못하게 종료되었을때 backup 된 weight로 중단된 지점부터 다시 학습을 진행할 수 있다.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">darknet detector train data/obj.data cfg/yolo-obj.cfg &lt;weight파일&gt; -dont_show</span><br></pre></td></tr></table></figure>



<p>학습을 마쳤다면 테스트를 아래와 같이 명령어로 수행해 볼 수 있다.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">darknet detector <span class="built_in">test</span> data/obj.data cfg/yolo-obj.cfg &lt;weight파일&gt; &lt;Image 파일&gt;</span><br></pre></td></tr></table></figure>

<p><img src="/assets/yolov3/test_cat_cli.PNG" alt=""></p>
<p><img src="/assets/yolov3/test_cat.PNG" alt="cat"></p>
<h3 id="2-4-번호판-인식-테스트"><a href="#2-4-번호판-인식-테스트" class="headerlink" title="2.4 번호판 인식 테스트"></a>2.4 번호판 인식 테스트</h3><p>2013장의 레이블링된 번호판 데이터를 45000번 학습된 Custom weight 데이터를 이용하여 블랙박스 영상에서 번호판 객체만을 인식시켜보는 테스트를 진행한다.</p>
<p>학습에 사용된 데이터는 <strong>1675장의 정지된 차량이미지 + 338장의 동영상 프레임 이미지</strong>이다.</p>
<p>다음으로는 각 Neural Network 프레임워크 별로 영상/이미지 객체 인식을 수행해본다.</p>
<p><code>weight 위치 :/data/plate/yolo-cits_final.weights</code></p>
<h4 id="2-4-1-pjreddie-darknet"><a href="#2-4-1-pjreddie-darknet" class="headerlink" title="2.4.1 pjreddie/darknet"></a>2.4.1 pjreddie/darknet</h4><p><a href="https://github.com/pjreddie/darknet">Github 링크</a></p>
<p><code>source : /home/kipang/workspace/pjreddie-darknet</code></p>
<p><code>.data, .cfg 위치 : /data/plate/cits.data, /data/plate/yolo-cits.cfg</code></p>
<p><code>darknet</code>은 <code>Yolo</code>구현에 필요한 <strong>Neural Network 프레임워크</strong>이다. C++, CUDA로 작성되었으며 <code>Github</code>에 오픈소스로 공개되어 있다.</p>
<p><code>darknet</code> 소스를 내려받으면 <code>Makefile</code>을 수정하여 GPU 호환을 활성화시킨다.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">git <span class="built_in">clone</span> https://github.com/pjreddie/darknet</span><br><span class="line"><span class="built_in">cd</span> darknet</span><br><span class="line">vi Makefile</span><br><span class="line">------------</span><br><span class="line">GPU=1</span><br><span class="line">CUDNN=1</span><br><span class="line">OPENCV=1</span><br><span class="line">OPENMP=0</span><br><span class="line">....</span><br><span class="line">------------</span><br><span class="line">make -j$(nproc)</span><br></pre></td></tr></table></figure>

<p>빌드가 끝나면 <code>darknet</code> 실행 바이너리 파일이 생성된다.</p>
<p>Custom weight 데이터로 객체인식을 수행하기 위해선 아래와 같이 실행해준다.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">darknet detector demo &lt;.data파일&gt; &lt;.cfg파일&gt; &lt;weight파일&gt; &lt;media파일&gt; -thresh &lt;임계값&gt;</span><br></pre></td></tr></table></figure>

<p><code>-thresh &lt;임계값&gt;</code>은 프레임에 클래스가 인식되었을때 해당 임계값을 초과할때만 객체로 인식하기위한 옵션이다. (default = 0.25, 25%)<br>따라서, 임계값을 조절하여 객체인식률을 조절할 수 있다.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">## For Image</span></span><br><span class="line">darknet detector <span class="built_in">test</span> data/cits.data cfg/yolo-cits.cfg weight/yolo-cits.weight ~/Video/carpark.jpg</span><br><span class="line"><span class="comment">## For Video stream</span></span><br><span class="line">darknet detector demo data/cits.data cfg/yolo-cits.cfg weight/yolo-cits.weight ~/Video/carpark.mp4</span><br></pre></td></tr></table></figure>

<p>실행 시 Video Player가 동작하여 결과를 Display 해준다.<br><img src="/assets/yolov3/pjreddie.PNG" alt="pjreddie"></p>
<h4 id="2-4-2-alexyAB-darknet"><a href="#2-4-2-alexyAB-darknet" class="headerlink" title="2.4.2 alexyAB/darknet"></a>2.4.2 alexyAB/darknet</h4><p><code>source : /home/kipang/workspace/alexyAB-darknet</code></p>
<p><code>2.4.1 pjreddie/darknet</code> 프로젝트를 <code>fork</code>하여 개발된 프레임워크로 몇가지 추가기능과 성능개선이 포함되어있다.  <a href="https://github.com/AlexeyAB/darknet">Github 링크</a> 상에 오픈소스로 공개되어있다.</p>
<p><strong>빌드 순서</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> darknet</span><br><span class="line">vi Makefile</span><br><span class="line">--------------</span><br><span class="line">GPU=1</span><br><span class="line">CUDNN=1</span><br><span class="line">OPENCV=1</span><br><span class="line">...</span><br><span class="line">--------------</span><br><span class="line">mkdir build</span><br><span class="line"><span class="built_in">cd</span> build</span><br><span class="line">cmake ..</span><br><span class="line">make -j$(nproc)</span><br></pre></td></tr></table></figure>

<p>추가기능은 <code>-thresh</code> 처럼 <code>flag</code>를 실행문 끝에 추가하여 아래 동작들을 수행할 수 있다.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">## Player 화면 숨기기</span></span><br><span class="line">darknet detector demo &lt;.data파일&gt; &lt;.cfg파일&gt; &lt;weight파일&gt; &lt;Media파일&gt; -dont_show</span><br><span class="line"></span><br><span class="line"><span class="comment">## 파일로 저장하기</span></span><br><span class="line">darknet detector demo &lt;.data파일&gt; &lt;.cfg파일&gt; &lt;weight파일&gt; &lt;Media파일&gt; -out_filename &lt;파일명&gt;</span><br><span class="line"></span><br><span class="line"><span class="comment">## Box 좌표 표시</span></span><br><span class="line">darknet detector demo &lt;.data파일&gt; &lt;.cfg파일&gt; &lt;weight파일&gt; &lt;Media파일&gt; -ext_output</span><br><span class="line"></span><br><span class="line"><span class="comment">## Web 브라우저 결과 출력 (http://xxx:port 접속)</span></span><br><span class="line">darknet detector demo &lt;.data파일&gt; &lt;.cfg파일&gt; &lt;weight파일&gt; &lt;Media파일&gt; -http_port &lt;port&gt;</span><br></pre></td></tr></table></figure>

<p>명령어를 실행하게 되면 <strong>Frame per Second</strong>로</p>
<p><img src="/assets/yolov3/alexyAB.PNG" alt="alexy"></p>
<p>와 같이 나타난다.</p>
<h4 id="2-4-3-DeepVisionX-Player"><a href="#2-4-3-DeepVisionX-Player" class="headerlink" title="2.4.3 DeepVisionX Player"></a>2.4.3 DeepVisionX Player</h4><p><a href="https://github.com/kmansoo/deep-vision-x-player">Github 링크</a></p>
<p><code>source : /home/kipang/workspace/deep-vision-x-player</code></p>
<p>기존 darknet 기반의 프레임워크로 stream 객체 인식시 동작하는 <strong>Video Player</strong>가 변경되었으며 실행시 <code>cfg</code>와 <code>data</code>파일의 <code>flag</code> 입력 순서가 다르다.</p>
<p><strong>빌드순서</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> deep-vision-x-player</span><br><span class="line">vi CMakeLists.txt</span><br><span class="line">------------------------</span><br><span class="line">option(USE_OPENCV       <span class="string">"Use OpenCV"</span>  ON)</span><br><span class="line">option(USE_CUDA         <span class="string">"Use CUDA"</span>    ON)</span><br><span class="line">option(USE_RELEASE_MODE <span class="string">"Use CUDA"</span>    ON)</span><br><span class="line">------------------------</span><br><span class="line">mkdir build</span><br><span class="line"><span class="built_in">cd</span> build</span><br><span class="line">cmake ..</span><br><span class="line">make -j$(nproc)</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">build/bin/DeepVisionXPlayer &lt;.cfg파일&gt; &lt;.data파일&gt; &lt;weight파일&gt; &lt;Media파일&gt;</span><br></pre></td></tr></table></figure>

<p><img src="/assets/yolov3/dxplayer2.PNG" alt="DVX Player"></p>
<p><strong>동영상의 프레임별 객체를 스캔/탐지하는데 걸린 시간</strong>, <strong>인식된 객체에 대한 confidence 수치</strong>를 나타나게 된다.</p>
</div><div class="article-tags size-small is-uppercase mb-4"><span class="mr-2">#</span><a class="link-muted mr-2" rel="tag" href="/tags/Docker/">Docker</a><a class="link-muted mr-2" rel="tag" href="/tags/Ubuntu/">Ubuntu</a><a class="link-muted mr-2" rel="tag" href="/tags/Machine-Learning/">Machine Learning</a><a class="link-muted mr-2" rel="tag" href="/tags/Computer-Vision/">Computer Vision</a></div><div class="a2a_kit a2a_kit_size_32 a2a_default_style"><a class="a2a_dd" href="https://www.addtoany.com/share"></a><a class="a2a_button_facebook"></a><a class="a2a_button_twitter"></a><a class="a2a_button_telegram"></a><a class="a2a_button_whatsapp"></a><a class="a2a_button_reddit"></a></div><script src="https://static.addtoany.com/menu/page.js" defer></script></article></div><!--!--><nav class="post-navigation mt-4 level is-mobile"><div class="level-start"><a class="article-nav-prev level level-item link-muted" href="/2019/11/10/Zeppelin/"><i class="level-item fas fa-chevron-left"></i><span class="level-item">Apache Zeppelin 설치</span></a></div><div class="level-end"><a class="article-nav-next level level-item link-muted" href="/2018/08/12/Proxmox_Hadoop_2/"><span class="level-item">Hadoop Clustering (2)</span><i class="level-item fas fa-chevron-right"></i></a></div></nav><div class="card"><div class="card-content"><h3 class="title is-5">댓글</h3><div id="disqus_thread"><noscript>Please enable JavaScript to view the <a href="//disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript></div><script>var disqus_config = function () {
            this.page.url = 'https://ok-data.github.io/2018/09/11/Yolov3/';
            this.page.identifier = '2018/09/11/Yolov3/';
        };
        (function() {
            var d = document, s = d.createElement('script');  
            s.src = '//' + 'ok-data' + '.disqus.com/embed.js';
            s.setAttribute('data-timestamp', +new Date());
            (d.head || d.body).appendChild(s);
        })();</script></div></div></div><!--!--><div class="column column-right is-4-tablet is-4-desktop is-4-widescreen  order-3 is-sticky"><div class="card widget" id="toc"><div class="card-content"><div class="menu"><h3 class="menu-label">카탈로그</h3><ul class="menu-list"><li><a class="is-flex" href="#1-Container화"><span class="mr-2">1</span><span>1. Container화</span></a><ul class="menu-list"><li><a class="is-flex" href="#1-1-NVIDA-드라이버-설치"><span class="mr-2">1.1</span><span>1.1 NVIDA 드라이버 설치</span></a></li><li><a class="is-flex" href="#1-2-Docker-Nvidia-docker-설치"><span class="mr-2">1.2</span><span>1.2 Docker / Nvidia-docker 설치</span></a></li><li><a class="is-flex" href="#1-3-CUDA-9-x-및-cudnn7-컨테이너화"><span class="mr-2">1.3</span><span>1.3 CUDA (9.x) 및 cudnn7 컨테이너화</span></a></li><li><a class="is-flex" href="#1-4-CMake-컨테이너화"><span class="mr-2">1.4</span><span>1.4 CMake 컨테이너화</span></a></li><li><a class="is-flex" href="#1-4-OpenCV-컨테이너화"><span class="mr-2">1.5</span><span>1.4 OpenCV 컨테이너화</span></a></li><li><a class="is-flex" href="#1-5-YOLOv3"><span class="mr-2">1.6</span><span>1.5 YOLOv3</span></a></li><li><a class="is-flex" href="#1-6-DeepVisionX-Player-테스트"><span class="mr-2">1.7</span><span>1.6 DeepVisionX Player 테스트</span></a></li></ul></li><li><a class="is-flex" href="#2-Ubuntu-16-04-Desktop"><span class="mr-2">2</span><span>2. Ubuntu 16.04 Desktop</span></a><ul class="menu-list"><li><a class="is-flex" href="#2-1-CUDA-ToolKit-9-0-cuDNN-7-설치"><span class="mr-2">2.1</span><span>2.1 CUDA-ToolKit 9.0, cuDNN 7 설치</span></a></li><li><a class="is-flex" href="#2-2-YOLO-mark를-이용한-데이터-labeling"><span class="mr-2">2.2</span><span>2.2 YOLO_mark를 이용한 데이터 labeling</span></a><ul class="menu-list"><li><a class="is-flex" href="#2-2-1-Video-frame-저장"><span class="mr-2">2.2.1</span><span>2.2.1 Video frame 저장</span></a></li></ul></li><li><a class="is-flex" href="#2-3-Custom-데이터셋-학습"><span class="mr-2">2.3</span><span>2.3 Custom 데이터셋 학습</span></a><ul class="menu-list"><li><a class="is-flex" href="#2-3-1-Preparation"><span class="mr-2">2.3.1</span><span>2.3.1 Preparation</span></a></li><li><a class="is-flex" href="#2-3-2-Training"><span class="mr-2">2.3.2</span><span>2.3.2 Training</span></a></li></ul></li><li><a class="is-flex" href="#2-4-번호판-인식-테스트"><span class="mr-2">2.4</span><span>2.4 번호판 인식 테스트</span></a><ul class="menu-list"><li><a class="is-flex" href="#2-4-1-pjreddie-darknet"><span class="mr-2">2.4.1</span><span>2.4.1 pjreddie/darknet</span></a></li><li><a class="is-flex" href="#2-4-2-alexyAB-darknet"><span class="mr-2">2.4.2</span><span>2.4.2 alexyAB/darknet</span></a></li><li><a class="is-flex" href="#2-4-3-DeepVisionX-Player"><span class="mr-2">2.4.3</span><span>2.4.3 DeepVisionX Player</span></a></li></ul></li></ul></li></ul></div></div></div><div class="card widget"><div class="card-content"><div class="menu"><h3 class="menu-label">카테고리</h3><ul class="menu-list"><li><a class="level is-mobile is-marginless" href="/categories/CUDA/"><span class="level-start"><span class="level-item">CUDA</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile is-marginless" href="/categories/Hadoop/"><span class="level-start"><span class="level-item">Hadoop</span></span><span class="level-end"><span class="level-item tag">4</span></span></a></li><li><a class="level is-mobile is-marginless" href="/categories/Hypervisor/"><span class="level-start"><span class="level-item">Hypervisor</span></span><span class="level-end"><span class="level-item tag">3</span></span></a></li><li><a class="level is-mobile is-marginless" href="/categories/Linux/"><span class="level-start"><span class="level-item">Linux</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile is-marginless" href="/categories/Machine-Learning/"><span class="level-start"><span class="level-item">Machine Learning</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile is-marginless" href="/categories/Oracle/"><span class="level-start"><span class="level-item">Oracle</span></span><span class="level-end"><span class="level-item tag">3</span></span></a></li><li><a class="level is-mobile is-marginless" href="/categories/Python/"><span class="level-start"><span class="level-item">Python</span></span><span class="level-end"><span class="level-item tag">3</span></span></a></li><li><a class="level is-mobile is-marginless" href="/categories/Spark/"><span class="level-start"><span class="level-item">Spark</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li></ul></div></div></div><div class="card widget"><div class="card-content"><div class="menu"><h3 class="menu-label">태그</h3><div class="field is-grouped is-grouped-multiline"><div class="control"><a class="tags has-addons" href="/tags/CUDA/"><span class="tag">CUDA</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Centos/"><span class="tag">Centos</span><span class="tag is-grey-lightest">5</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Computer-Vision/"><span class="tag">Computer Vision</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Docker/"><span class="tag">Docker</span><span class="tag is-grey-lightest">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Hadoop/"><span class="tag">Hadoop</span><span class="tag is-grey-lightest">7</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Hive/"><span class="tag">Hive</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Hypervisor/"><span class="tag">Hypervisor</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Jupyter/"><span class="tag">Jupyter</span><span class="tag is-grey-lightest">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/KVM/"><span class="tag">KVM</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/LXC/"><span class="tag">LXC</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Linux/"><span class="tag">Linux</span><span class="tag is-grey-lightest">10</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Machine-Learning/"><span class="tag">Machine Learning</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/NVIDIA/"><span class="tag">NVIDIA</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Oracle/"><span class="tag">Oracle</span><span class="tag is-grey-lightest">3</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Proxmox/"><span class="tag">Proxmox</span><span class="tag is-grey-lightest">3</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Python/"><span class="tag">Python</span><span class="tag is-grey-lightest">3</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Spark/"><span class="tag">Spark</span><span class="tag is-grey-lightest">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Tensorflow/"><span class="tag">Tensorflow</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Ubuntu/"><span class="tag">Ubuntu</span><span class="tag is-grey-lightest">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Windows/"><span class="tag">Windows</span><span class="tag is-grey-lightest">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Zeppelin/"><span class="tag">Zeppelin</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/cuDNN/"><span class="tag">cuDNN</span><span class="tag is-grey-lightest">1</span></a></div></div></div></div></div></div></div></div></section><footer class="footer"><div class="container"><div class="level"><div class="level-start"><a class="footer-logo is-block mb-2" href="/"><img src="/assets/title_logo.png" alt="okdata" height="28"></a><p class="size-small"><span>&copy; 2020 okdata</span>  Powered by <a href="https://hexo.io/" target="_blank" rel="noopener">Hexo</a> &amp; <a href="https://github.com/ppoffice/hexo-theme-icarus" target="_blank" rel="noopener">Icarus</a></p></div><div class="level-end"><div class="field has-addons"><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Creative Commons" href="https://creativecommons.org/"><i class="fab fa-creative-commons"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Attribution 4.0 International" href="https://creativecommons.org/licenses/by/4.0/"><i class="fab fa-creative-commons-by"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Download on GitHub" href="https://github.com/ok-data"><i class="fab fa-github"></i></a></p></div></div></div></div></footer><script src="https://cdn.jsdelivr.net/npm/jquery@3.3.1/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/moment@2.22.2/min/moment-with-locales.min.js"></script><script>moment.locale("ko");</script><script>var IcarusThemeSettings = {
            site: {
                url: 'https://ok-data.github.io',
                external_link: {"enable":true,"exclude":[]}
            },
            article: {
                highlight: {
                    clipboard: true,
                    fold: 'unfolded'
                }
            }
        };</script><script src="https://cdn.jsdelivr.net/npm/clipboard@2.0.4/dist/clipboard.min.js" defer></script><script src="/js/animation.js"></script><a id="back-to-top" title="Back to Top" href="javascript:;"><i class="fas fa-chevron-up"></i></a><script src="/js/back_to_top.js" defer></script><!--!--><!--!--><script src="https://cdn.jsdelivr.net/npm/lightgallery@1.6.8/dist/js/lightgallery.min.js" defer></script><script src="https://cdn.jsdelivr.net/npm/justifiedGallery@3.7.0/dist/js/jquery.justifiedGallery.min.js" defer></script><script>window.addEventListener("load", () => {
            if (typeof $.fn.lightGallery === 'function') {
                $('.article').lightGallery({ selector: '.gallery-item' });
            }
            if (typeof $.fn.justifiedGallery === 'function') {
                if ($('.justified-gallery > p > .gallery-item').length) {
                    $('.justified-gallery > p > .gallery-item').unwrap();
                }
                $('.justified-gallery').justifiedGallery();
            }
        });</script><!--!--><!--!--><!--!--><script src="/js/main.js" defer></script><div class="searchbox"><div class="searchbox-container"><div class="searchbox-header"><div class="searchbox-input-container"><input class="searchbox-input" type="text" placeholder="입력 하세요..."></div><a class="searchbox-close" href="javascript:;">×</a></div><div class="searchbox-body"></div></div></div><script src="/js/insight.js" defer></script><script>document.addEventListener('DOMContentLoaded', function () {
            loadInsight({"contentUrl":"/content.json"}, {"hint":"입력 하세요...","untitled":"(Untitled)","posts":"포스트","pages":"Pages","categories":"카테고리","tags":"태그"});
        });</script></body></html>